---
title: "05b Model Full"
author: "J Andres Gannon"
date: "April 23, 2020"
output:
  html_document:
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---
<style>
    body .main-container {
        max-width: 100%;
    }
</style>

This document will create the model examining the explanatory power of alliance variables in explaining specialization.

# Prep
Pipe operators have trouble loading in-line so we load those first.
```{r}
library(magrittr)
library(ggplot2)
```

# Load and clean data
## Load
We start by loading the cleaned IISS data. This dataframe contains information about the count of military units at the country-year level.
```{r}
df <- readRDS(file = paste0(here::here(), '/data/df_fulldata.rds')) %>%
  dplyr::ungroup()
```

## Summarize
Show distributions of the variables
```{r}
# DV comparisons
df %>%
  dplyr::select(d, fentrop, p_si, sd,
                dplyr::ends_with("_norm")) %>%
  GGally::ggpairs()

# Distribution of DV
df %>%
  ggplot(aes(x = sd)) + 
  geom_density() + 
  theme_minimal()

df %>%
  ggplot(aes(x = sd_norm)) + 
  geom_density() + 
  theme_minimal()

# Distribution of country-year defense pact membership
df %>%
  ggplot(aes(x = atop_atopally)) + 
  geom_bar() + 
  theme_minimal()

df %>%
  dplyr::group_by(year) %>%
  ggplot(aes(x = year,
             y = atop_atopcount)) + 
  geom_point() + 
  theme_minimal()

df %>%
  dplyr::group_by(year) %>%
  ggplot(aes(x = dca_binary)) + 
  geom_bar() + 
  theme_minimal()

df %>%
  dplyr::group_by(year) %>%
  ggplot(aes(x = year,
             y = dca_count)) + 
  geom_point() + 
  theme_minimal()

# Correlation with military spending with country names
df %>%
  ggplot(aes(x = milex_MC,
             y = sd_norm)) +
  geom_point()

df %>%
  dplyr::filter(country == "United Kingdom") %>%
  plotly::plot_ly(x = ~milex_MC,
                  y = ~sd_norm,
                  text = ~paste(country, "(", year, ")
                                <br> Specialization:", round(sd_norm, 2)))

# Check missing
naniar::gg_miss_var(df)

naniar::gg_miss_var(df,
                    facet = decade)
```

# Models
## M1 DCA membership
### Prep vars
```{r}
df_m1 <- df %>%
  dplyr::select(sd_norm,
                dca_binary,
                democracy,
                interstatewar_5yrlag_binary,
                lngdp_WDI_full,
                greatpower,
                country,
                decade,
                year) %>%
  dplyr::mutate(dca_binary = as.factor(dca_binary),
                greatpower = as.factor(greatpower),
                democracy = as.factor(democracy),
                interstatewar_5yrlag_binary = as.factor(interstatewar_5yrlag_binary),
                country = as.factor(country),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = sd_norm)

naniar::gg_miss_var(df_m1,
                    facet = decade)
```

### Bivariate
```{r}
m1_bi <- lm(dv ~ dca_binary,
         data = df_m1)
summary(m1_bi)

m1_bicse <- lmtest::coeftest(m1_bi, 
                              vcov = sandwich::vcovCL(m1_bi, factor(df$country)))
m1_bicse
```

### Multivariate
```{r}
m1_mult <- lm(dv ~ 
           dca_binary + 
           democracy +
           interstatewar_5yrlag_binary +
           lngdp_WDI_full +
           greatpower,
         data = df_m1)
summary(m1_mult)
```

### Multi + decade FE
```{r}
m1_dfe <- lm(dv ~ 
               dca_binary + 
               democracy +
               interstatewar_5yrlag_binary +
               lngdp_WDI_full +
               greatpower +
               decade,
             data = df_m1)
summary(m1_dfe)
```

### Multi + decade FE + country SE
```{r}
m1_dfecse <- lmtest::coeftest(m1_dfe, 
                              vcov = sandwich::vcovCL(m1_dfe, factor(df$country)))
m1_dfecse
```

### Multi + splines
```{r}
# df_m1 <- df_m1 %>%
#  dplyr::mutate(dca_binary = dplyr::recode(dca_binary,
#                                           '0' = "No",
#                                           '1' = "Yes"))

# df_m1$dv <- scales::rescale(df_m1$dv)

m1_spline <- lm(dv ~ 
                  dca_binary + 
                  democracy +
                  interstatewar_5yrlag_binary +
                  lngdp_WDI_full +
                  greatpower +
                  year +
                  year_sq +
                  year_cube,
                data = df_m1)
summary(m1_spline)
```

### Multi + splines + country SE
```{r}
m1_splinecse <- lmtest::coeftest(m1_spline,
                                 vcov = sandwich::vcovCL(m1_spline, factor(df$country)))
m1_splinecse
```

## M2 DCA count
### Prep vars
```{r}
df_m2 <- df %>%
  dplyr::select(sd_norm,
                dca_count,
                democracy,
                interstatewar_5yrlag_binary,
                lngdp_WDI_full,
                greatpower,
                country,
                decade,
                year) %>%
  dplyr::mutate(greatpower = as.factor(greatpower),
                democracy = as.factor(democracy),
                interstatewar_5yrlag_binary = as.factor(interstatewar_5yrlag_binary),
                country = as.factor(country),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = sd_norm)

naniar::gg_miss_var(df_m2,
                    facet = decade)
```

### Bivariate
```{r}
m2_bi <- lm(dv ~
              dca_count,
            data = df_m2)
summary(m2_bi)

m2_bicse <- lmtest::coeftest(m2_bi,
                              vcov = sandwich::vcovCL(m2_bi, factor(df$country)))
m2_bicse
```

### Multivariate
```{r}
m2_mult <- lm(dv ~ 
                dca_count + 
                democracy +
                interstatewar_5yrlag_binary +
                lngdp_WDI_full +
                greatpower,
              data = df_m2)
summary(m2_mult)
```

### Multi + decade FE
```{r}
m2_dfe <- lm(dv ~ 
               dca_count + 
               democracy +
               interstatewar_5yrlag_binary +
               lngdp_WDI_full +
               greatpower +
               decade,
             data = df_m2)
summary(m2_dfe)
```

### Multi + decade FE + country SE
```{r}
m2_dfecse <- lmtest::coeftest(m2_dfe,
                              vcov = sandwich::vcovCL(m2_dfe, factor(df$country)))
m2_dfecse
```

### Multi + splines
```{r}
m2_spline <- lm(dv ~ 
                  dca_count + 
                  democracy +
                  interstatewar_5yrlag_binary +
                  lngdp_WDI_full +
                  greatpower +
                  year +
                  year_sq +
                  year_cube,
                data = df_m2)
summary(m2_spline)
```

### Multi + splines + country SE
```{r}
m2_splinecse <- lmtest::coeftest(m2_spline,
                                 vcov = sandwich::vcovCL(m2_spline, factor(df$country)))
m2_splinecse
```

## M3 Defence pact count
### Prep vars
```{r}
# Variable selection
df_m3 <- df %>%
  dplyr::select(sd_norm,
                atop_atopcount,
                democracy,
                interstatewar_5yrlag_binary,
                lngdp_WDI_full,
                greatpower,
                country,
                decade,
                year) %>%
  dplyr::mutate(greatpower = as.factor(greatpower),
                democracy = as.factor(democracy),
                interstatewar_5yrlag_binary = as.factor(interstatewar_5yrlag_binary),
                country = as.factor(country),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = sd_norm)

naniar::gg_miss_var(df_m3,
                    facet = decade)
```

### Bivariate
```{r}
m3_bi <- lm(dv ~ 
           atop_atopcount,
         data = df_m3)
summary(m3_bi)

m3_bicse <- lmtest::coeftest(m3_bi, 
                              vcov = sandwich::vcovCL(m3_bi, factor(df$country)))
m3_bicse
```

### Multivariate
```{r}
m3_mult <- lm(dv ~ 
                atop_atopcount + 
                democracy +
                interstatewar_5yrlag_binary +
                lngdp_WDI_full +
                greatpower,
              data = df_m3)
summary(m3_mult)
```

### Multi + decade FE
```{r}
m3_dfe <- lm(dv ~ 
               atop_atopcount + 
               democracy +
               interstatewar_5yrlag_binary +
               lngdp_WDI_full +
               greatpower +
               decade,
             data = df_m3)
summary(m3_dfe)
```

### Multi + decade FE + country SE
```{r}
m3_dfecse <- lmtest::coeftest(m3_dfe,
                              vcov = sandwich::vcovCL(m3_dfe, factor(df$country)))
m3_dfecse
```

### Multi + splines
```{r}
m3_spline <- lm(dv ~ 
                  atop_atopcount + 
                  democracy +
                  interstatewar_5yrlag_binary +
                  lngdp_WDI_full +
                  greatpower +
                  year +
                  year_sq +
                  year_cube,
                data = df_m3)
summary(m3_spline)
```

### Multi + splines + country SE
```{r}
m3_splinecse <- lmtest::coeftest(m3_spline,
                                 vcov = sandwich::vcovCL(m3_spline, factor(df$country)))
m3_splinecse
```

# Results
## Tables
### Full table
```{r}
# Make list of models
models <- list(m1_bicse, m1_splinecse,
               m2_bicse, m2_splinecse,
               m3_bicse, m3_splinecse)

texreg::texreg(models,
               omit.coef = "decade|Intercept|year",
               custom.coef.names = c("DCA Member",
                                     "Democracy",
                                     "Interstate War (5yr lag)",
                                     "GDP (log)",
                                     "Great power",
                                     "DCA Count",
                                     "Defense Pact Count"),
               groups = (list("Independent Variables" = 1:3, "Controls" = 4:7)),
               reorder.coef = c(1, 6, 7, 2, 3, 4, 5),
               custom.note = "\\item %stars \\\\\n All models include country-clustered standard errors. Scaled cubic polynomials in full models not shown.",
               label = "table:model",
               float.pos = "h",
               caption = "OLS regression results",
               use.packages = FALSE,
               threeparttable = TRUE,
               file = paste0(here::here(), "/paper/figures/model_results/","paper2_models.tex"))
```

## Plots
### Model summary
```{r}
# Choose models
models <- list(m1_bi, m1_splinecse,
               m2_bi, m2_splinecse,
               m3_bi, m3_splinecse)

# Modelsummary
coefs <- c('dca_binary1' = 'DCA Member',
           'dca_count' = 'DCA Count',
           'atop_atopcount' = 'Defense Pact Member')

modelsummary::modelplot(models,
                        coef_map = coefs) +
  labs(title = 'Alliance Variable Results',
       x = 'Coefficients',
       y = 'Independent Variables',
       caption = 'Multivariate models include country-clustered standard errors and scaled year polynomials. Control variables not shown.')

# sjPlot
evplot <- sjPlot::plot_models(models,
                    rm.terms = c("democracy1",
                                 "interstatewar_5yrlag_binary1",
                                 "lngdp_WDI_full",
                                 "greatpower1",
                                 "year",
                                 "year_sq",
                                 "year_cube",
                                 "decade1980",
                                 "decade1990",
                                 "decade2000",
                                 "decade2010"),
                    axis.labels = c("Defense Pact Count",
                                    "DCA Count",
                                    "DCA Member"),
                    show.values = TRUE,
                    p.threshold = c(0.1, 0.05, 0.01),
                    digits = 3,
                    vline.color = "black",
                    colors = c("firebrick", "blue"),
                    show.legend = FALSE,
                    title = "Relationship Between Alliances and Military Specialization") +
  theme_minimal() +
  labs(caption = "All 3 independent variables run as separate models \n Blue models are bivariate. Red models include all controls, country-clustered standard errors, and scaled year polynomials")

evplot

sjPlot::save_plot(fig = evplot, 
                  filename = paste0(here::here(),"/paper/figures/model_results/specialization_EVonly.png"),
                  width = 18,
                  height = 12)
```

### Effects plots
```{r}
df %>%
  dplyr::select(year, country, sd_norm, atop_atopcount, milex_MC, gdp_WDI_full) %>%
  DT::datatable(filter = "top")

sd(df$atop_atopcount)

# M1 multivariate
g <- jtools::effect_plot(m1_spline,
                    pred = dca_binary,
                    interval = TRUE,
                    main.title = "Marginal Effects of Defense Cooperation Agreements (DCA)",
                    x.label = "DCA Member",
                    y.label = "Military Specialization") +
  theme(text = element_text(size = 30),
        plot.title = element_text(size = 22))
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper2_effectplot_dcabinary.png"), height = 8, width = 10, units = "in")

# M2 multivariate
g <- jtools::effect_plot(m2_spline,
                    pred = dca_count,
                    interval = TRUE,
                    partial.residuals = TRUE,
                    jitter = 0.5,
                    x.label = "DCA Count",
                    y.label = "Military Specialization") +
  theme(text = element_text(size = 16))
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper2_effectplot_dcacount.png"), height = 8, width = 16, units = "in")

# M3 multivariate
g <- jtools::effect_plot(m3_spline,
                    pred = atop_atopcount,
                    interval = TRUE,
                    partial.residuals = TRUE,
                    jitter = 0.5,
                    main.title = "Marginal Effects of Number of Defense Pacts",
                    x.label = "Defense Pact Count",
                    y.label = "Military Specialization") +
  theme(text = element_text(size = 20),
        plot.title = element_text(size = 22))
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper2_effectplot_atopcount.png"), height = 8, width = 12, units = "in")

```

# Diagnostics
```{r}
performance::check_model(m1_spline)

performance::performance_accuracy(m1_mult)

performance::compare_performance(m1_bi, m1_mult, m1_dfe, m1_spline)
```
